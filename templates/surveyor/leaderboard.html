{% extends 'base.html' %}

{% block sidebar %}
<li class="nav-item">
  <a class="nav-link" href="{% url 'dashboard' %}">
    <span data-feather="home"></span>
    Dashboard
  </a>
</li>
<li class="nav-item">
  <a class="nav-link active" href="{% url 'leaderboard' %}">
    <span data-feather="award"></span>
    Leaderboard
  </a>
</li>
<li class="nav-item">
  <a class="nav-link" href="{% url 'groups' %}">
    <span data-feather="grid"></span>
    Groups
  </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{% url 'users' %}">
      <span data-feather="users"></span>
      Manage Users<span class="sr-only">(current)</span>
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{% url 'history' %}">
      <span data-feather="clock"></span>
      Task History
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{% url 'organisation' %}">
      <span data-feather="globe"></span>
    Organisation
    </a>
</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
  <h1>Leaderboard</h1>
</div>
<div class="btn-group pt-3 mb-4" role="group" id="button-container">
  <button class="btn btn-primary mr-2 rounded" onclick="render({{ overall_leaderboard | safe }}, this)">Overall</button>
  {% for gr in groups %}
    <button class="btn btn-light mr-2 rounded" onclick="render({{ gr.leaderboard | safe }}, this)">{{ gr }}</button>
  {% endfor %}
</div>
<div>
  <table class="table table-striped table-hover" id="leaderboard">
    <thead class="thead">
    <tr>
        <th>Rank</th>
        <th>Name</th>
        <th><span style="border-bottom: 1px dotted black;" data-toggle="tooltip" data-placement="right" title="This is a simple average of all quantifiable responses. Responses to Likert Scales are given a value 1-5, and Traffic Lights a value between 1-3.">Score</span></th>
    </tr>
    </thead>
    <tbody id="table-body">
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
  function select_button(target_button) {
    // Deactivate all other buttons
    var parent = document.getElementById('button-container');
    var buttons = parent.children;
    for (var i = 0; i < buttons.length; i++) {
      var button = buttons[i];
      if (button.classList.contains('btn-primary')) {
        button.classList.remove('btn-primary');
        button.classList.add('btn-light');
      }
    }
    // Activate new button
    target_button.classList.remove('btn-light');
    target_button.classList.add('btn-primary');
  }

  function render(leaderboardData, button) {
      clear_leaderboard();
      select_button(button);
      render_leaderboard(leaderboardData);
  };

  function add_row (parent, rank, name, score) {
    var row_wrapper = document.createElement('tr');

    var name_wrapper = document.createElement('td');
    var score_wrapper = document.createElement('td');
    var rank_wrapper = document.createElement('td');

    rank_wrapper.textContent = rank;
    name_wrapper.textContent = name;
    score_wrapper.textContent = score;

    var new_elements = [];
    new_elements.push(rank_wrapper, name_wrapper, score_wrapper);
    
    for (var i = 0; i < new_elements.length; i++) {
      row_wrapper.appendChild(new_elements[i]);
    }
    parent.appendChild(row_wrapper);
  }

  function clear_leaderboard () {
    var parent = document.getElementById('table-body');
    while (parent.firstChild) parent.removeChild(parent.lastChild);
  }

  function render_leaderboard(leaderboard) {
    var parent = document.getElementById('table-body');

    for (var i=0; i < leaderboard.length; i++) {
      var row = leaderboard[i];
      add_row(parent, i + 1, row['name'], row['score']);
    }
  }

  $(function () {
    render_leaderboard({{ overall_leaderboard | safe }});
  });

</script>
{% endblock %}