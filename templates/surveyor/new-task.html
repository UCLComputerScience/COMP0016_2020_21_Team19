{% extends 'base.html' %}

{% block sidebar %}
<li class="nav-item">
    <a class="nav-link" href="{% url 'dashboard' %}">
      <span data-feather="home"></span>
      Dashboard
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{% url 'leaderboard' %}">
      <span data-feather="award"></span>
      Leaderboard
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{% url 'groups' %}">
      <span data-feather="grid"></span>
      Groups
    </a>
  </li>
  <li class="nav-item">
      <a class="nav-link" href="{% url 'users' %}">
        <span data-feather="users"></span>
        Manage Users<span class="sr-only">(current)</span>
      </a>
  </li>
  <li class="nav-item">
      <a class="nav-link" href="{% url 'history' %}">
        <span data-feather="clock"></span>
        Task History
      </a>
  </li>
  <li class="nav-item">
      <a class="nav-link" href="{% url 'organisation' %}">
        <span data-feather="globe"></span>
      Organisation
      </a>
  </li>
{% endblock %}

{% block content %}
<form method="post">
    {% csrf_token %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2">Create New Task</h1>
        <div class="btn-toolbar">
            {% if templates %}
            <a class="btn btn-primary ml-2 mb-2" id="load">Load from Template</a>
            {% endif %}
            <button class="btn btn-primary ml-2 mb-2" name="save" value="save" type="submit" id="save">Save as Template</button>
            <a class="btn btn-danger ml-2 mb-2" href="{% url 'dashboard' %}">Cancel</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-7 mb-2">
            <label for="title">{{ taskform.title.label }}</label>
            {{ taskform.title }}
        </div>
        <div class="col-md-5 mb-2">
            <label>{{ taskform.group.label }}</label>
            {{ taskform.group }}
        </div>
    </div>

    <hr class="mb-4">
    <h4 class="mb-3">Content</h4>

    {{ formset.management_form }}
    <div id="form_set">
    {% for form in formset %}
      {{ form.id }}
      <div class="row">
        <div class="col-md-6 mb-3">
            <label for="question1">{{ form.description.label }}</label>
            {{ form.description }}
        </div>

        <div class="col-md-3 mb-3">
            <label for="url">{{ form.link.label }}<span class="text-muted"> (Optional)</span></label>
            {{ form.link }}
        </div>

        <div class="col-md-2 mb-3">
            <label for="responseType">{{ form.response_type.label }}</label>
            {{ form.response_type }}
        </div>
        {% if forloop.counter != 1 %}
        <div class="col-md-1 mb-3">
          <div style="display: none;">
            {{ form.DELETE }}
          </div>
          <label class="invisible">Delete</label>
          <button type="button" class="form-control btn btn-outline-danger" onclick="deleteRow(this.parentElement.parentElement);">Delete</button>
        </div>
        {% endif %}
      </div>
    {% endfor %}
    </div>

    <input type="button" class="btn btn-success" value="Add More" id="add_more">

    <hr class="mb-4">

    <h4 class="mb-3">Due</h4>

    <div class="row">
        <div class="col-md-3 mb-2">
            <label for="date">{{ taskform.due_date.label }}</label>
            {{ taskform.due_date }}
        </div>
        <div class="col-md-3 mb-2">
            <label for="time">{{ taskform.due_time.label }}</label>
            {{ taskform.due_time }}
        </div>
    </div>
    <hr class="mb-4">
    <button class="btn btn-primary btn-lg btn-block" name="submit" value="submit" type="submit">Submit</button>

    <div>
      <div class="modal fade" id="modal-save">
        <div class="modal-dialog">
          <div class="modal-content">
            {% include "surveyor/partials/save-template.html" %}
          </div>
        </div>
      </div>
    </div>

</form>

<div id="empty_form" style="display:none">
  <div class="row">
    
    <div class="col-md-6 mb-3">
        <label for="question1">{{ formset.empty_form.description.label }}</label>
        {{ formset.empty_form.description }}
    </div>

    <div class="col-md-3 mb-3">
        <label for="url">{{ formset.empty_form.link.label }}<span class="text-muted"> (Optional)</span></label>
        {{ formset.empty_form.link }}
    </div>

    <div class="col-md-2 mb-3">
        <label for="responseType">{{ formset.empty_form.response_type.label }}</label>
        {{ formset.empty_form.response_type }}
    </div>

    <div class="col-md-1 mb-3">
      <div style="display: none;">
          {{ formset.empty_form.DELETE }}
      </div>
      <label class="invisible">Delete</label>
      <button type="button" class="form-control btn btn-outline-danger" onclick="deleteRow(this.parentElement.parentElement);">Delete</button>
    </div>
  </div>
</div>

<div>
  <div class="modal fade" id="modal-load">
    <div class="modal-dialog">
      <div class="modal-content">
        {% include "surveyor/partials/load-template.html" %}
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<link href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css">
<script
  src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
  integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
  crossorigin="anonymous">
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>

<script>
    $("#load").click(function () {
      $("#modal-load").modal('show');
    });

    $('#add_more').click(function () {
        var form_idx = $('#id_form-TOTAL_FORMS').val();
        $('#form_set').append($('#empty_form').html().replace(/__prefix__/g, form_idx));
        $('#id_form-TOTAL_FORMS').val(parseInt(form_idx) + 1);
    });
    
    function deleteRow(row) {
        var form_idx = $('#id_form-TOTAL_FORMS').val();
        var inputElem = row.getElementsByTagName('INPUT')[0].id;
        inputElem = inputElem.replace("description", "DELETE");
        $("#" + inputElem).prop('checked', true);
        row.remove();
    }

    function browserSupportsDateInput() {
        var i = document.createElement("input");
        i.setAttribute("type", "date");
        return i.type !== "text";
    }

    if(!browserSupportsDateInput()) {
        $(function() {
            $( "#id_due_date" ).datepicker();
        });
        $(document).ready(function(){
            $('input.timepicker').timepicker({
                timeFormat: 'HH:mm',
                dynamic: true,
            });
        });
    }

    const allFields = ['id_group', 'id_due_date', 'id_due_time'] // put all your field ids here

    $("#save").click(function () {
      // Set all your fields back to optional
      allFields.forEach(function(field) {
          $( "#" + field ).removeAttr('required');
      });
      // Then trigger the hidden input field to submit the form and send the POST request
      $( "#save" ).trigger( "click" );

      requiredFields.forEach(function(field) {
          $( "#" + field ).attr('required', '');
      });
    });

    $(".delete-template").click(function () {
        if (confirm('Are you sure you want to delete this template?')) {
            var btn = $(this);
            var template = btn.data('template');
            var form = $('<form method="post">');
            form.append('{% csrf_token %}');
            form.append('<input name="template" value="' + template + '" />');
            form.append('<input name="request_type" value="delete_template" />');
            $('body').append(form);
            form.submit();
        }
        else {
            return false;
        }
        if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;
    });
</script>

{% endblock %}